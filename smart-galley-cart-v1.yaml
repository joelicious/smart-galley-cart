apiVersion: camel.apache.org/v1
kind: Integration
metadata:
  name: smart-galley-cart-v1.yaml
spec:
  flows:
    - restConfiguration:
        corsHeaders:
          - value: '*'
            key: Access-Control-Allow-Origin
        host: 192.168.1.167
        port: '8080'
        bindingMode: auto
        enableCors: true
    - rest:
        post:
          - id: change-cart-lights
            path: /cart/lights
            consumes: application/json
            produces: application/json
            to: direct:change-cart-lights
            bindingMode: 'off'
            enableCors: true
          - id: change-cart-sign
            path: /cart/sign
            consumes: application/json
            to: direct:change-cart-sign
            bindingMode: 'off'
            produces: application/json
            enableCors: true
        get:
          - id: get-door-state
            path: /cart/door/state
            to: direct:get-door-state
            bindingMode: 'off'
            produces: application/json
            enableCors: true
    - route:
        from:
          uri: direct:get-door-state
          steps:
            - log:
                message: GET cart door state
            - setHeader:
                name: CamelCaffeineKey
                expression:
                  simple:
                    expression: doorState
            - to:
                uri: caffeine-cache:galleyCart
                parameters:
                  action: GET
                  createCacheIfNotExist: true
            - choice:
                when:
                  - expression:
                      simple:
                        expression: ${body} == 'on'
                    steps:
                      - setBody:
                          expression:
                            simple:
                              expression: '{"doorState":"open"}'
                      - setHeader:
                          name: CamelHttpResponseCode
                          expression:
                            simple:
                              expression: '200'
                  - expression:
                      simple:
                        expression: ${body} == 'off'
                    steps:
                      - setBody:
                          expression:
                            simple:
                              expression: '{"doorState":"closed"}'
                      - setHeader:
                          name: CamelHttpResponseCode
                          expression:
                            simple:
                              expression: '200'
                otherwise:
                  steps:
                    - setHeader:
                        name: CamelHttpResponseCode
                        expression:
                          simple:
                            expression: '400'
                    - setBody:
                        expression:
                          simple:
                            expression: '{"code":400,"message":"Unknown"}'
        id: cartDoorStateRoute
    - route:
        from:
          uri: direct:change-cart-lights
          steps:
            - log:
                message: 'POST Cart Lights Body: ${body}'
            - choice:
                when:
                  - expression:
                      jsonpath:
                        expression: $.[?(@['on'] == true)]
                        suppressExceptions: true
                    steps:
                      - setHeader:
                          name: led_brightness
                          expression:
                            jsonpath:
                              expression: '@[''brightness'']'
                      - choice:
                          when:
                            - expression:
                                jsonpath:
                                  expression: $.[?(@['colorOne'] == 'red')]
                                  suppressExceptions: true
                              steps:
                                - setHeader:
                                    name: colorOne
                                    expression:
                                      simple:
                                        expression: 255,0,0
                            - expression:
                                jsonpath:
                                  expression: $.[?(@['colorOne'] == 'white')]
                                  suppressExceptions: true
                              steps:
                                - setHeader:
                                    name: colorOne
                                    expression:
                                      simple:
                                        expression: 255,255,255
                            - expression:
                                jsonpath:
                                  expression: $.[?(@['colorOne'] == 'blue')]
                                  suppressExceptions: true
                              steps:
                                - setHeader:
                                    name: colorOne
                                    expression:
                                      simple:
                                        expression: 0,255,0
                            - expression:
                                jsonpath:
                                  expression: $.[?(@['colorOne'] == 'green')]
                                  suppressExceptions: true
                              steps:
                                - setHeader:
                                    name: colorOne
                                    expression:
                                      simple:
                                        expression: 0,0,255
                      - choice:
                          when:
                            - expression:
                                jsonpath:
                                  expression: $.[?(@['colorTwo'] == 'red')]
                                  suppressExceptions: true
                              steps:
                                - setHeader:
                                    name: colorTwo
                                    expression:
                                      simple:
                                        expression: 255,0,0
                            - expression:
                                jsonpath:
                                  expression: $.[?(@['colorTwo'] == 'white')]
                                  suppressExceptions: true
                              steps:
                                - setHeader:
                                    name: colorTwo
                                    expression:
                                      simple:
                                        expression: 255,255,255
                            - expression:
                                jsonpath:
                                  expression: $.[?(@['colorTwo'] == 'blue')]
                                  suppressExceptions: true
                              steps:
                                - setHeader:
                                    name: colorTwo
                                    expression:
                                      simple:
                                        expression: 0,255,0
                            - expression:
                                jsonpath:
                                  expression: $.[?(@['colorTwo'] == 'green')]
                                  suppressExceptions: true
                              steps:
                                - setHeader:
                                    name: colorTwo
                                    expression:
                                      simple:
                                        expression: 0,0,255
                      - setBody:
                          expression:
                            simple:
                              expression: >-
                                {"on":true, "bri":${header.led_brightness},
                                "seg":[{"col":[[${header.colorOne}],[${header.colorTwo}],[0,0,0]],"fx":37]}
                      - to:
                          uri: paho:wled/{{mqtt.topic.lights}}/api
                          parameters:
                            brokerUrl: tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                            retained: true
                      - setHeader:
                          name: CamelHttpResponseCode
                          expression:
                            simple:
                              expression: '200'
                      - setBody:
                          expression:
                            simple:
                              expression: '{"code":200,"message":"SUCCESS"}'
                  - expression:
                      jsonpath:
                        expression: $.[?(@['on'] == false)]
                        suppressExceptions: true
                    steps:
                      - setBody:
                          expression:
                            simple:
                              expression: T=0
                      - to:
                          uri: paho:wled/{{mqtt.topic.lights}}/api
                          parameters:
                            brokerUrl: tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                            retained: true
                      - setHeader:
                          name: CamelHttpResponseCode
                          expression:
                            simple:
                              expression: '200'
                      - setBody:
                          expression:
                            simple:
                              expression: '{"code":200,"message":"SUCCESS"}'
                otherwise:
                  steps:
                    - setHeader:
                        name: CamelHttpResponseCode
                        expression:
                          simple:
                            expression: '400'
                    - setBody:
                        expression:
                          simple:
                            expression: '{"code":400,"message":"Invalid state"}'
        id: changeCartLightsRoute
    - route:
        from:
          uri: direct:change-cart-sign
          steps:
            - log:
                message: 'POST Cart Sign Body: ${body}'
            - choice:
                when:
                  - expression:
                      jsonpath:
                        expression: $.[?(@['on'] == true)]
                        suppressExceptions: true
                    steps:
                      - log:
                          message: Sign On
                      - choice:
                          when:
                            - expression:
                                jsonpath:
                                  expression: $.[?(@['pattern'] == 'karavan')]
                                  suppressExceptions: true
                              steps:
                                - log:
                                    message: Sign Karavan
                                - setHeader:
                                    name: led_brightness
                                    expression:
                                      jsonpath:
                                        expression: '@[''brightness'']'
                                - setBody:
                                    expression:
                                      simple:
                                        expression: >-
                                          {"on":true,
                                          "bri":${header.led_brightness},
                                          "seg":{"i":[
                                                  0,52,[142,169,219], 52,54,[48,84,150], 54,56,[180,198,231], 56,[142,169,219], 57,[255,255,255], 58,66,[142,169,219], 66,71,[255,255,255], 71,73,[180,198,231], 73,77,[48,84,150], 77,82,[142,169,219], 82,88,[48,84,150], 88,95,[255,255,255], 95,99,[142,169,219], 99,105,[255,255,255], 105,111,[48,84,150], 111,[142,169,219], 112,118,[48,84,150], 118,124,[255,255,255], 124,127,[180,198,231], 127,[142,169,219], 128,133,[180,198,231], 133,139,[255,255,255], 139,143,[48,84,150], 143,154,[255,255,255], 154,167,[180,198,231], 167,184,[255,255,255], 184,[48,84,150], 185,199,[180,198,231], 199,201,[48,84,150], 201,213,[255,255,255], 213,217,[48,84,150], 217,232,[180,198,231], 232,237,[48,84,150], 237,241,[255,255,255], 241,248,[48,84,150], 248,256,[180,198,231]
                                                ]}}
                                - to:
                                    uri: paho:wled/{{mqtt.topic.sign}}/api
                                    parameters:
                                      brokerUrl: >-
                                        tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                                      retained: true
                                - setHeader:
                                    name: CamelHttpResponseCode
                                    expression:
                                      simple:
                                        expression: '200'
                                - setBody:
                                    expression:
                                      simple:
                                        expression: '{"code":200,"message":"SUCCESS"}'
                            - expression:
                                jsonpath:
                                  expression: $.[?(@['pattern'] == 'camel')]
                                  suppressExceptions: true
                              steps:
                                - log:
                                    message: Sign Camel
                                - setHeader:
                                    name: led_brightness
                                    expression:
                                      jsonpath:
                                        expression: '@[''brightness'']'
                                - setBody:
                                    expression:
                                      simple:
                                        expression: >-
                                          {"on":true,
                                          "bri":${header.led_brightness},
                                          "seg":{"i":[
                                                  0,52,[237,125,49], 52,54,[131,60,12], 54,56,[252,228,214], 56,[237,125,49], 57,[255,255,255], 58,66,[237,125,49], 66,71,[255,255,255], 71,73,[252,228,214], 73,77,[131,60,12], 77,82,[237,125,49], 82,88,[131,60,12], 88,95,[255,255,255], 95,99,[237,125,49], 99,105,[255,255,255], 105,111,[131,60,12], 111,[237,125,49], 112,118,[131,60,12], 118,124,[255,255,255], 124,127,[252,228,214], 127,[237,125,49], 128,133,[252,228,214], 133,139,[255,255,255], 139,143,[131,60,12], 143,154,[255,255,255], 154,167,[252,228,214], 167,184,[255,255,255], 184,[131,60,12], 185,199,[252,228,214], 199,201,[131,60,12], 201,213,[255,255,255], 213,217,[131,60,12], 217,232,[252,228,214], 232,237,[131,60,12], 237,241,[255,255,255], 241,248,[131,60,12], 248,256,[252,228,214]
                                                ]}}
                                - to:
                                    uri: paho:wled/{{mqtt.topic.sign}}/api
                                    parameters:
                                      brokerUrl: >-
                                        tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                                      retained: true
                                - setHeader:
                                    name: CamelHttpResponseCode
                                    expression:
                                      simple:
                                        expression: '200'
                                - setBody:
                                    expression:
                                      simple:
                                        expression: '{"code":200,"message":"SUCCESS"}'
                            - expression:
                                jsonpath:
                                  expression: $.[?(@['pattern'] == 'beer')]
                                  suppressExceptions: true
                              steps:
                                - log:
                                    message: Beer
                                - setHeader:
                                    name: led_brightness
                                    expression:
                                      jsonpath:
                                        expression: '@[''brightness'']'
                                - setHeader:
                                    name: CamelCaffeineKey
                                    expression:
                                      simple:
                                        expression: doorState
                                - to:
                                    uri: caffeine-cache:galleyCart
                                    parameters:
                                      action: GET
                                      createCacheIfNotExist: true
                                - log:
                                    message: doorState ${body}
                                - choice:
                                    when:
                                      - expression:
                                          simple:
                                            expression: ${body} == 'on'
                                        steps:
                                          - log:
                                              message: Full Beer
                                          - setBody:
                                              expression:
                                                simple:
                                                  expression: T=0
                                          - to:
                                              uri: paho:wled/{{mqtt.topic.sign}}/api
                                              parameters:
                                                brokerUrl: >-
                                                  tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                                                retained: true
                                          - setBody:
                                              expression:
                                                simple:
                                                  expression: >-
                                                    {"on":true, "bri":50, "seg":{"i":[
                                                    0,53,[255,217,102], 53,59,[255,255,255],
                                                    59,68,[255,217,102],
                                                    68,76,[255,255,255],
                                                    76,84,[255,217,102],
                                                    84,93,[255,255,255],
                                                    93,100,[255,217,102],
                                                    101,106,[255,255,255],
                                                    106,[255,217,102],
                                                    108,114,[255,217,102],
                                                    117,[255,217,102], 118,[191,143,0],
                                                    119,[255,217,102],
                                                    120,122,[255,255,255],
                                                    122,[255,217,102],
                                                    124,132,[255,217,102],
                                                    133,[255,217,102], 134,[191,143,0],
                                                    135,[255,255,255], 136,[255,217,102],
                                                    137,[191,143,0], 138,[255,217,102],
                                                    140,[255,217,102],
                                                    142,146,[255,217,102],
                                                    147,[255,217,102], 149,[255,217,102],
                                                    150,[191,143,0], 151,[255,217,102],
                                                    152,[255,255,255], 153,[191,143,0],
                                                    154,[255,217,102],
                                                    156,164,[255,217,102],
                                                    165,[255,217,102], 166,[191,143,0],
                                                    167,169,[255,217,102], 169,[191,143,0],
                                                    170,[255,217,102], 172,[255,217,102],
                                                    174,179,[255,217,102],
                                                    181,[255,217,102], 182,[191,143,0],
                                                    183,185,[255,217,102], 185,[191,143,0],
                                                    186,[255,217,102],
                                                    188,196,[255,217,102],
                                                    197,203,[191,143,0],
                                                    204,213,[255,217,102],
                                                    219,256,[255,217,102]]}}
                                          - to:
                                              uri: paho:wled/{{mqtt.topic.sign}}/api
                                              parameters:
                                                brokerUrl: >-
                                                  tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                                                retained: true
                                      - expression:
                                          simple:
                                            expression: ${body} == 'off'
                                        steps:
                                          - log:
                                              message: Empty Beer
                                          - setBody:
                                              expression:
                                                simple:
                                                  expression: T=0
                                          - to:
                                              uri: paho:wled/{{mqtt.topic.sign}}/api
                                              parameters:
                                                brokerUrl: >-
                                                  tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                                                retained: true
                                          - setBody:
                                              expression:
                                                simple:
                                                  expression: >-
                                                    {"on":true, "bri":50, "seg":{"i":[
                                                    0,100,[255,217,102],
                                                    101,107,[255,217,102],
                                                    108,114,[255,217,102],
                                                    117,123,[255,217,102],
                                                    124,132,[255,217,102],
                                                    133,139,[255,217,102],
                                                    140,[255,217,102],
                                                    142,146,[255,217,102],
                                                    147,[255,217,102],
                                                    149,155,[255,217,102],
                                                    156,164,[255,217,102],
                                                    165,171,[255,217,102],
                                                    172,[255,217,102],
                                                    174,179,[255,217,102],
                                                    181,187,[255,217,102],
                                                    188,196,[255,217,102],
                                                    197,199,[191,143,0],
                                                    199,202,[255,255,255], 202,[191,143,0],
                                                    204,213,[255,217,102],
                                                    219,256,[255,217,102]
                                                          ]}}
                                          - to:
                                              uri: paho:wled/{{mqtt.topic.sign}}/api
                                              parameters:
                                                brokerUrl: >-
                                                  tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                                                retained: true
                                    precondition: false
                                - setHeader:
                                    name: CamelHttpResponseCode
                                    expression:
                                      simple:
                                        expression: '200'
                                - setBody:
                                    expression:
                                      simple:
                                        expression: '{"code":200,"message":"SUCCESS"}'
                  - expression:
                      jsonpath:
                        expression: $.[?(@['on'] == false)]
                        suppressExceptions: true
                    steps:
                      - log:
                          message: Sign Off
                      - setBody:
                          expression:
                            simple:
                              expression: T=0
                      - to:
                          uri: paho:wled/{{mqtt.topic.sign}}/api
                          parameters:
                            brokerUrl: tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                            retained: true
                      - setHeader:
                          name: CamelHttpResponseCode
                          expression:
                            simple:
                              expression: '200'
                      - setBody:
                          expression:
                            simple:
                              expression: '{"code":200,"message":"SUCCESS"}'
                otherwise:
                  steps:
                    - setHeader:
                        name: CamelHttpResponseCode
                        expression:
                          simple:
                            expression: '400'
                    - setBody:
                        expression:
                          simple:
                            expression: '{"code":400,"message":"Invalid state"}'
        id: changeCartSignRoute
    - route:
        from:
          uri: paho:wled/{{mqtt.topic.lights}}/button/1
          steps:
            - log:
                message: Button pressed ${body}
            - setHeader:
                name: CamelCaffeineKey
                expression:
                  simple:
                    expression: doorState
            - to:
                uri: caffeine-cache:galleyCart
                parameters:
                  action: PUT
                  createCacheIfNotExist: true
            - choice:
                when:
                  - expression:
                      simple:
                        expression: ${body} == 'on'
                    steps:
                      - log:
                          message: Full Beer
                      - setBody:
                          expression:
                            simple:
                              expression: T=0
                      - to:
                          uri: paho:wled/{{mqtt.topic.sign}}/api
                          parameters:
                            brokerUrl: tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                            retained: true
                      - setBody:
                          expression:
                            simple:
                              expression: >-
                                {"on":true, "bri":50, "seg":{"i":[
                                0,53,[255,217,102], 53,59,[255,255,255],
                                59,68,[255,217,102], 68,76,[255,255,255],
                                76,84,[255,217,102], 84,93,[255,255,255],
                                93,100,[255,217,102], 101,106,[255,255,255],
                                106,[255,217,102], 108,114,[255,217,102],
                                117,[255,217,102], 118,[191,143,0],
                                119,[255,217,102], 120,122,[255,255,255],
                                122,[255,217,102], 124,132,[255,217,102],
                                133,[255,217,102], 134,[191,143,0],
                                135,[255,255,255], 136,[255,217,102],
                                137,[191,143,0], 138,[255,217,102],
                                140,[255,217,102], 142,146,[255,217,102],
                                147,[255,217,102], 149,[255,217,102],
                                150,[191,143,0], 151,[255,217,102],
                                152,[255,255,255], 153,[191,143,0],
                                154,[255,217,102], 156,164,[255,217,102],
                                165,[255,217,102], 166,[191,143,0],
                                167,169,[255,217,102], 169,[191,143,0],
                                170,[255,217,102], 172,[255,217,102],
                                174,179,[255,217,102], 181,[255,217,102],
                                182,[191,143,0], 183,185,[255,217,102],
                                185,[191,143,0], 186,[255,217,102],
                                188,196,[255,217,102], 197,203,[191,143,0],
                                204,213,[255,217,102], 219,256,[255,217,102]]}}
                      - to:
                          uri: paho:wled/{{mqtt.topic.sign}}/api
                          parameters:
                            brokerUrl: tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                            retained: true
                  - expression:
                      simple:
                        expression: ${body} == 'off'
                    steps:
                      - log:
                          message: Empty Beer
                      - setBody:
                          expression:
                            simple:
                              expression: T=0
                      - to:
                          uri: paho:wled/{{mqtt.topic.sign}}/api
                          parameters:
                            brokerUrl: tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                            retained: true
                      - setBody:
                          expression:
                            simple:
                              expression: >-
                                {"on":true, "bri":50, "seg":{"i":[
                                0,100,[255,217,102], 101,107,[255,217,102],
                                108,114,[255,217,102], 117,123,[255,217,102],
                                124,132,[255,217,102], 133,139,[255,217,102],
                                140,[255,217,102], 142,146,[255,217,102],
                                147,[255,217,102], 149,155,[255,217,102],
                                156,164,[255,217,102], 165,171,[255,217,102],
                                172,[255,217,102], 174,179,[255,217,102],
                                181,187,[255,217,102], 188,196,[255,217,102],
                                197,199,[191,143,0], 199,202,[255,255,255],
                                202,[191,143,0], 204,213,[255,217,102],
                                219,256,[255,217,102]
                                      ]}}
                      - to:
                          uri: paho:wled/{{mqtt.topic.sign}}/api
                          parameters:
                            brokerUrl: tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
                            retained: true
                precondition: false
          parameters:
            brokerUrl: tcp://{{mqtt.broker.ip}}:{{mqtt.broker.port}}
            password: joe
            userName: joe
            retained: true
        id: mqttSwitchEvents
